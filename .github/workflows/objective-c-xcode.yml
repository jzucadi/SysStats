name: CI

  on:
    push:
      branches: ["main"]
    pull_request:
      branches: ["main"]

  concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

  jobs:
    build:
      name: Build and Test
      runs-on: macos-14
      timeout-minutes: 15

      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Select Xcode Version
          run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

        - name: Show Build Environment
          run: |
            xcodebuild -version
            swift --version

        - name: Build
          run: |
            xcodebuild clean build \
              -project SysStats.xcodeproj \
              -scheme SysStats \
              -destination 'platform=macOS,arch=arm64' \
              -configuration Debug \
              ONLY_ACTIVE_ARCH=YES \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              2>&1 | grep -E "(error:|warning:|BUILD)" || true

            # Run again to get exit code
            xcodebuild build \
              -project SysStats.xcodeproj \
              -scheme SysStats \
              -destination 'platform=macOS,arch=arm64' \
              -configuration Debug \
              ONLY_ACTIVE_ARCH=YES \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO

        - name: Run Tests
          run: |
            xcodebuild test \
              -project SysStats.xcodeproj \
              -scheme SysStats \
              -destination 'platform=macOS,arch=arm64' \
              -configuration Debug \
              ONLY_ACTIVE_ARCH=YES \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO
